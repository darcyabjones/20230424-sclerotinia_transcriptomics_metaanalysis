#!/bin/bash --login

module load system/Miniconda3

source /home/djones/.bashrc && eval "$(conda shell.bash hook)"
conda activate ./caretta_condaenv

set -euo pipefail

mkdir -p work
mkdir -p output/cluster_aligned

if [ -s 08b-align_clusters.log ]
then
  RESUME_COMMAND="--batch-resume 08b-align_clusters.log"
else
  RESUME_COMMAND=""
fi

read -d '' TARGET_IDS <<EOF || :
A0A1D9PTT3
A0A1D9PXE6
A0A1D9PXM6
A0A1D9PY34
A0A1D9Q1F4
A0A1D9Q2E9
A0A1D9Q3S2
A0A1D9Q3U0
A0A1D9Q6G7
A0A1D9Q705
A0A1D9Q985
A0A1D9QA98
A0A1D9QER3
A0A1D9QHL3
A0A1D9QMU9
A0A1D9QMV4
A0A384J478
A0A384J6U0
A0A384J998
A0A384JAC8
A0A384JF26
A0A384JJQ1
A0A384JPK8
A0A384K7G1
A0A395IIK6
A0A395IJM4
A0A395IM03
A0A395IVS6
A0A395J775
A0A4S8QK50
A0A4S8QKL2
A0A4S8QNQ5
A0A4S8QRK1
A0A4S8QSN5
A0A4S8QTN4
A0A4S8QV41
A0A4S8QX69
A0A4S8QZ19
A0A4S8R0M9
A0A4S8R124
A0A4S8R6M1
A0A4S8R8H0
A0A4S8RK32
A0A4S8RN59
A0A4V4HU67
A0A4V4HVU0
A0A4Y8CF03
A0A4Y8CMI0
A0A4Y8CN40
A0A4Y8CN71
A0A4Y8CRQ7
A0A4Y8DCP2
A0A4Y8DI35
A0A4Z1E5N2
A0A4Z1E858
A0A4Z1E8Y6
A0A4Z1EA15
A0A4Z1EDX0
A0A4Z1EGJ3
A0A4Z1EKI8
A0A4Z1ELZ5
A0A4Z1EQR1
A0A4Z1ETC7
A0A4Z1F8T7
A0A4Z1FE37
A0A4Z1FEC2
A0A4Z1FLJ6
A0A4Z1FLR0
A0A4Z1FQE1
A0A4Z1FVE8
A0A4Z1G3K9
A0A4Z1G8M0
A0A4Z1GR89
A0A4Z1GS31
A0A4Z1GVU7
A0A4Z1GX79
A0A4Z1GXU5
A0A4Z1H1N3
A0A4Z1H553
A0A4Z1H6V7
A0A4Z1HJ50
A0A4Z1HLZ7
A0A4Z1HV63
A0A4Z1I5N2
A0A4Z1I6L6
A0A4Z1IBU0
A0A4Z1IDK5
A0A4Z1IL00
A0A4Z1IUZ6
A0A4Z1IWS9
A0A4Z1IYJ2
A0A4Z1J680
A0A4Z1J758
A0A4Z1JBI2
A0A4Z1JEU1
A0A4Z1JWN8
A0A4Z1JXT5
A0A4Z1JYI3
A0A4Z1K3J6
A0A4Z1K4W8
A0A4Z1KCC2
A0A4Z1KCI8
A0A4Z1KGT1
A0A4Z1KHE8
A0A4Z1KQE3
A0A4Z1KQH8
A0A5M9JC25
A0A5M9JCM1
A0A5M9JPQ2
A0A5M9JXW7
A0A5N6JZE3
A0A5N6K0M5
A0A5N6K723
A0A5N6KKB7
A0A7S5VU75
A0A8A3NV85
A0A8A3PBE4
A0A8A3PEZ0
A0A8A3PHE1
A0A8A3PIF8
A0A8A3PL22
A0A8A3PNU2
A0A8A3PRW1
A7E5B8
A7E5I9
A7EBK3
A7EF06
A7EHR5
A7EKU2
A7EQ91
A7EYN8
G2XR00
G2Y4N2
G2YBR8
G2YLR2
G2YU50
H6W9D7
H6W9E6
M7TDL5
M7TKS2
M7TPJ3
M7TSP5
M7TXJ0
M7TXT3
M7U109
M7U9J6
M7UPB7
M7UV02
M7UZB2
Q079H6
Q2VF46
W9CGG1
W9CGH1
EOF


echo "${TARGET_IDS}" \
| pt -f - 'code/run_caretta.sh work/alphafold_structures_trimmed output/clusters_with_ips.tsv {} output/08b-aligned_clusters' \
| ../code/slurm_scripts/bin/sbatch_parallel.sh \
  --account djones \
  --export=ALL \
  --ntasks 8 \
  --cpus-per-task 4 \
  --partition workq \
  --batch-setup 'source /home/djones/.bashrc && unset PERL5LIB && eval "$(conda shell.bash hook)"' \
  --batch-module system/Miniconda3 \
  ${RESUME_COMMAND} \
  --time 16:00:00 \
  --batch-condaenv ${PWD}/caretta_condaenv 
